name: microservices ci-cd

on:
  push:
    paths:
      - "src/**"

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set.outputs.services }}

    steps:
      - uses: actions/checkout@v4

      - id: set
        run: |
          SERVICES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
            | grep '^src/' \
            | cut -d/ -f2 \
            | sort -u \
            | jq -R -s -c 'split("\n")[:-1]')

          if [ "$SERVICES" = "[]" ]; then
            echo "services=[]" >> $GITHUB_OUTPUT
          else
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
          fi


  build:
    needs: detect_changes
    if: needs.detect_changes.outputs.services != '[]'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services) }}

    uses: ./.github/workflows/reusable-build.yml
    with:
      service_name: ${{ matrix.service }}
      service_path: src/${{ matrix.service }}
